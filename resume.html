<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curr√≠culo Profissional</title>
    <link rel="stylesheet" href="assets/css/resume.css">
</head>
<body>
    <div class="resume-container">
        <div class="resume-content" id="resumeContent">
            <!-- Conte√∫do ser√° injetado via JavaScript -->
        </div>
    </div>

    <div class="actions-bar">
        <button type="button" onclick="imprimirCurriculo(); return false;" class="btn">üñ®Ô∏è Imprimir / Salvar PDF</button>
        <button type="button" onclick="window.close(); return false;" class="btn">‚Üê Voltar</button>
    </div>

    <script>
        // Vari√°veis globais para armazenar dados
        let resumeDataGlobal = null;
        let personalDataGlobal = null;

        // Load resume from sessionStorage and render
        document.addEventListener('DOMContentLoaded', () => {
            const resumeData = sessionStorage.getItem('current_resume');
            
            if (!resumeData) {
                document.getElementById('resumeContent').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <h2>Nenhum curr√≠culo carregado</h2>
                        <p>Por favor, gere um curr√≠culo no sistema principal primeiro.</p>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 12px 24px; cursor: pointer;">Voltar</button>
                    </div>
                `;
                return;
            }
            
            try {
                resumeDataGlobal = JSON.parse(resumeData);
                personalDataGlobal = resumeDataGlobal.personalData || {};

                console.log(resumeDataGlobal)
                
                // --- NOVO: Atualizar t√≠tulo da p√°gina ---
                const empresa = resumeDataGlobal.vaga_alvo?.empresa || '';
                const headline = resumeDataGlobal.header?.headline || 'Desenvolvedor';
                const nomeCompleto = personalDataGlobal.name || '';

                // Criar string do title
                let titleString = `${empresa} | ${headline} | ${nomeCompleto}`;

                // Regras: min√∫sculo, espa√ßos ‚Üí _, prefixo cv_
                titleString = 'cv ' + titleString
                    .toLowerCase()
                    .trim()

                document.title = titleString;
                // --- FIM NOVO ---
                
                if (Object.keys(personalDataGlobal).length === 0) {
                    const timestamp = new Date().getTime();
                    fetch(`/data/personal-data.json?t=${timestamp}`)
                        .then(res => res.json())
                        .then(personalData => {
                            personalDataGlobal = personalData;
                            renderResume(resumeDataGlobal, personalData);
                        })
                        .catch(err => renderResume(resumeDataGlobal, {}));
                } else {
                    renderResume(resumeDataGlobal, personalDataGlobal);
                }
            } catch (error) {
                console.error('Erro ao processar curr√≠culo:', error);
                alert('Erro ao carregar curr√≠culo: ' + error.message);
            }
        });

        function imprimirCurriculo() {
            // Garantir que os dados est√£o carregados antes de imprimir
            if (!resumeDataGlobal || !document.getElementById('resumeContent').innerHTML) {
                alert('Aguarde o curr√≠culo carregar completamente antes de imprimir.');
                return;
            }
            
            // Salvar posi√ß√£o atual do scroll
            const scrollPos = window.scrollY;
            
            // Usar timeout para garantir que a p√°gina est√° renderizada
            setTimeout(() => {
                window.print();
                
                // Restaurar posi√ß√£o do scroll ap√≥s impress√£o
                setTimeout(() => {
                    window.scrollTo(0, scrollPos);
                }, 100);
            }, 100);
            
            // Prevenir qualquer a√ß√£o que possa resetar a p√°gina
            return false;
        }
        
        // Prevenir que o evento de impress√£o cause scroll
        window.addEventListener('beforeprint', (e) => {
            document.body.style.overflow = 'visible';
        });
        
        window.addEventListener('afterprint', (e) => {
            document.body.style.overflow = 'auto';
        });

        function renderResume(data, personalData) {
            function formatPeriod(period) {
                if (!period) return '';
                if (typeof period === 'string') return period;
                const start = period.start ? formatDate(period.start) : '';
                const end = period.end === 'current' ? 'Atual' : (period.end ? formatDate(period.end) : '');
                return `${start} ‚Äì ${end}`;
            }

            function formatDate(dateStr) {
                if (!dateStr) return '';
                if (dateStr.length === 4) return dateStr;
                const [year, month] = dateStr.split('-');
                const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                return `${months[parseInt(month) - 1]} ${year}`;
            }

            // Usar personalData se existir, sen√£o tentar do data
            const personal = personalData || data.personalData || {};
            
            console.log('Personal data na renderiza√ß√£o:', personal);

            // Verificar quais campos incluir baseado nas checkboxes
            const shouldInclude = (field) => {
                const includeField = `include_${field}`;
                // Se o campo n√£o existe em personal, retornar true (default)
                if (personal[includeField] === undefined) return true;
                return personal[includeField] === true;
            };

            // Adaptar estrutura do header
            const header = data.header || data;
            const meta = data.meta || {};
            
            // Pegar dados pessoais com fallback
            const name = shouldInclude('name') ? (personal.name || header.nome || header.name || '') : '';
            const email = shouldInclude('email') ? (personal.email || header.email || '') : '';
            const phone = shouldInclude('phone') ? (personal.phone || header.telefone || header.phone || '') : '';
            const linkedin = shouldInclude('linkedin') ? (personal.linkedin || header.linkedin || '') : '';
            const github = shouldInclude('github') ? (personal.github || header.github || '') : '';
            const portfolio = shouldInclude('portfolio') ? (personal.portfolio || header.portfolio || '') : '';
            
            const headline = meta.cargo_alvo || header.headline || 'Desenvolvedor';
            
            // Construir location string
            let location = '';
            const showCity = shouldInclude('city');
            const showState = shouldInclude('state');
            
            if (showCity || showState) {
                const city = showCity ? (personal.city || '') : '';
                const state = showState ? (personal.state || '') : '';
                if (city && state) {
                    location = `${city}, ${state}`;
                } else if (city) {
                    location = city;
                } else if (state) {
                    location = state;
                }
            }
            
            const showRemote = shouldInclude('remote') && (personal.remote === true);

            console.log('Dados renderizados:', { name, email, phone, linkedin, github, portfolio, location });

            const html = `
                <div class="resume-header">
                    ${name ? `<h1 class="name">${name}</h1>` : ''}
                    <div class="headline">${headline}</div>
                    ${email || phone ? `
                        <div class="contact-info">
                            ${email ? `<span>e-mail: ${email}</span>` : ''}
                            ${email && phone ? ' | ' : ''}
                            ${phone ? `<span>celular e WhatsApp: ${phone}</span>` : ''}
                        </div>
                    ` : ''}
                    ${linkedin || github || portfolio ? `
                        <div class="contact-info">
                            ${linkedin ? `<span>LinkedIn: ${linkedin.replace('https://', '').replace('http://', '')}</span>` : ''}
                            ${linkedin && (github || portfolio) ? ' | ' : ''}
                            ${github ? `<span>GitHub: ${github.replace('https://', '').replace('http://', '')}</span>` : ''}
                            ${github && portfolio ? ' | ' : ''}
                            ${portfolio ? `<span>Portf√≥lio: ${portfolio.replace('https://', '').replace('http://', '')}</span>` : ''}
                        </div>
                    ` : ''}
                    ${location || showRemote ? `
                        <div class="contact-info">
                            ${location ? `<span>${location}</span>` : ''}
                            ${location && showRemote ? ' | ' : ''}
                            ${showRemote ? '<span>Dispon√≠vel para trabalho remoto</span>' : ''}
                        </div>
                    ` : ''}
                </div>

                ${data.summary ? `
                    <div class="section">
                        <h2 class="section-title">RESUMO PROFISSIONAL</h2>
                        <p class="summary-text">${data.summary}</p>
                    </div>
                ` : ''}

                ${data.core_competencies ? `
                    <div class="section">
                        <h2 class="section-title">COMPET√äNCIAS T√âCNICAS</h2>
                        <div class="skills-grid">
                            ${Object.entries(data.core_competencies).map(([key, values]) => {
                                if (!values || values.length === 0) return '';
                                const titles = {
                                    'backend': 'Backend & Frameworks',
                                    'languages_runtime': 'Linguagens & Runtime',
                                    'frameworks_libraries': 'Frameworks & Bibliotecas',
                                    'databases': 'Bancos de Dados',
                                    'bancos_de_dados': 'Bancos de Dados',
                                    'cloud_infrastructure': 'Cloud & Infraestrutura',
                                    'devops_e_infra': 'DevOps & Infraestrutura',
                                    'messaging_queues': 'Mensageria & Filas',
                                    'mensageria_e_integracao': 'Mensageria & Integra√ß√£o',
                                    'testing_quality': 'Testes & Qualidade',
                                    'devops_ci_cd': 'DevOps & CI/CD',
                                    'methodologies': 'Metodologias',
                                    'seguranca': 'Seguran√ßa'
                                };
                                return `
                                    <div class="skill-group">
                                        <strong>${titles[key] || key.replace(/_/g, ' ')}:</strong>
                                        <span>${Array.isArray(values) ? values.join(', ') : values}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}

                ${data.experience && data.experience.length > 0 ? `
                    <div class="section">
                        <h2 class="section-title">EXPERI√äNCIA PROFISSIONAL</h2>
                        ${data.experience.map(exp => {
                            const role = exp.role || exp.projeto || exp.position || 'Desenvolvedor';
                            const company = exp.company || exp.empresa || '';
                            const period = exp.periodo || formatPeriod(exp.period);
                            
                            let highlights = exp.highlights || exp.descricao || exp.description || [];
                            if (typeof highlights === 'string') {
                                highlights = [highlights];
                            }
                            
                            return `
                            <div class="experience-item">
                                <div class="exp-header">
                                    <div>
                                        <h3 class="exp-role">${role}</h3>
                                        ${company ? `<div class="exp-company">${company}</div>` : ''}
                                    </div>
                                    <div class="exp-period">${period}</div>
                                </div>
                                ${highlights && highlights.length > 0 ? `
                                    <ul class="highlights">
                                        ${highlights.map(h => `<li>${h}</li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${exp.stack && exp.stack.length > 0 ? `
                                    <div style="margin-top: 8px; font-size: 13px; color: #6b7280;">
                                        <strong>Stack:</strong> ${exp.stack.join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                        `}).join('')}
                    </div>
                ` : ''}

                ${data.projects && data.projects.length > 0 ? `
                    <div class="section">
                        <h2 class="section-title">PROJETOS EM DESTAQUE</h2>
                        ${data.projects.map(proj => `
                            <div class="project-item">
                                <h3 class="project-name">${proj.name}</h3>
                                ${proj.description ? `<p>${proj.description}</p>` : ''}
                                ${proj.impact && proj.impact.length > 0 ? `
                                    <ul class="project-impact">
                                        ${proj.impact.map(i => `<li>${i}</li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${data.education && data.education.length > 0 ? `
                    <div class="section">
                        <h2 class="section-title">FORMA√á√ÉO ACAD√äMICA</h2>
                        ${data.education.map(edu => `
                            <div class="education-item">
                                <strong>${edu.degree || edu.curso}</strong><br>
                                ${edu.institution || edu.instituicao}${edu.period ? ` ‚Ä¢ ${formatPeriod(edu.period)}` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${data.certifications && data.certifications.length > 0 ? `
                    <div class="section">
                        <h2 class="section-title">CERTIFICA√á√ïES</h2>
                        ${data.certifications.map(cert => `
                            <div class="cert-item">
                                <strong>${cert.name}</strong> ‚Ä¢ ${cert.issuer}${cert.date ? ` ‚Ä¢ ${formatDate(cert.date)}` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${data.languages && data.languages.length > 0 ? `
                    <div class="section">
                        <h2 class="section-title">IDIOMAS</h2>
                        <div class="languages">
                            ${data.languages.map(lang => {
                                const language = lang.language || lang.idioma;
                                const proficiency = lang.proficiency || lang.nivel;
                                return `<span><strong>${language}:</strong> ${proficiency}</span>`;
                            }).join(' ‚Ä¢ ')}
                        </div>
                    </div>
                ` : ''}
            `;

            document.getElementById('resumeContent').innerHTML = html;
        }
    </script>
</body>
</html>