<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curr√≠culo Profissional</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/resume.css">
    <style>body.in-iframe .actions-bar { display: none !important; }</style>
</head>
<body>
    <div class="resume-container">
        <div class="resume-content" id="resumeContent">
            <div style="display:flex;align-items:center;justify-content:center;height:60vh;gap:12px;color:#6b7280;">
                <div style="width:22px;height:22px;border:3px solid #e5e7eb;border-top-color:#1e40af;border-radius:50%;animation:spin 0.7s linear infinite;"></div>
                Carregando curr√≠culo‚Ä¶
            </div>
        </div>
    </div>
    <div class="actions-bar" id="actionsBar">
        <button type="button" onclick="window.print()" class="btn">üñ®Ô∏è Imprimir / Salvar PDF</button>
        <button type="button" onclick="window.close()" class="btn">‚Üê Fechar</button>
    </div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
    <script>
        let resumeDataGlobal = null;
        let personalDataGlobal = null;

        document.addEventListener('DOMContentLoaded', () => {
            const emIframe = window.self !== window.top;
            if (emIframe) document.body.classList.add('in-iframe');

            const resumeData = sessionStorage.getItem('current_resume');
            if (!resumeData) {
                document.getElementById('resumeContent').innerHTML = `
                    <div style="text-align:center;padding:60px 20px;">
                        <h2 style="color:#111827;margin-bottom:12px;">Nenhum curr√≠culo carregado</h2>
                        <p style="color:#6b7280;">Gere um curr√≠culo no sistema principal primeiro.</p>
                    </div>`;
                return;
            }

            try {
                resumeDataGlobal = JSON.parse(resumeData);
                personalDataGlobal = resumeDataGlobal.personalData || {};
                const titulo = gerarTituloPagina(resumeDataGlobal, personalDataGlobal);
                document.title = titulo;
                renderResume(resumeDataGlobal, personalDataGlobal);
            } catch (error) {
                document.getElementById('resumeContent').innerHTML = `
                    <div style="text-align:center;padding:40px;">
                        <p style="color:#dc2626;">Erro ao carregar curr√≠culo: ${error.message}</p>
                    </div>`;
            }
        });

        function gerarTituloPagina(data, personalData) {
            const limpar = str => (str||'').toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                .replace(/[^a-z0-9\s]/g,'').trim().replace(/\s+/g,'_');
            const nomeCompleto = personalData?.name || '';
            const partes = nomeCompleto.trim().split(/\s+/);
            const nome = partes.length >= 2 ? `${partes[0]} ${partes[partes.length-1]}` : partes[0]||'';
            const empresa = data?.vaga_alvo?.empresa || data?.curriculo?.vaga_alvo?.empresa || '';
            const cargo = data?.titulo_curriculo || data?.curriculo?.titulo_curriculo || data?.header?.headline || data?.curriculo?.header?.headline || '';
            return ['cv', limpar(nome), limpar(empresa), limpar(cargo)].filter(Boolean).join('_');
        }

        window.addEventListener('beforeprint', () => { document.body.style.overflow = 'visible'; });
        window.addEventListener('afterprint',  () => { document.body.style.overflow = 'auto'; });

        function formatPeriod(period) {
            if (!period) return '';
            if (typeof period === 'string') return period;
            const start = period.start ? formatDate(period.start) : '';
            const end = period.end === 'current' ? 'Atual' : (period.end ? formatDate(period.end) : '');
            return `${start} ‚Äì ${end}`;
        }
        function formatDate(dateStr) {
            if (!dateStr) return '';
            if (dateStr.length === 4) return dateStr;
            const [year, month] = dateStr.split('-');
            const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            return `${months[parseInt(month)-1]} ${year}`;
        }

        function renderResume(data, personalData) {
            const personal = personalData || {};
            const shouldInclude = f => personal[`include_${f}`] === undefined ? true : personal[`include_${f}`] === true;
            const flat = data.curriculo || data;
            const header = flat.header || {};
            const meta   = flat.meta   || {};

            const name      = shouldInclude('name')      ? (personal.name      || header.name      || '') : '';
            const email     = shouldInclude('email')     ? (personal.email     || header.email     || '') : '';
            const phone     = shouldInclude('phone')     ? (personal.phone     || header.phone     || '') : '';
            const linkedin  = shouldInclude('linkedin')  ? (personal.linkedin  || header.linkedin  || '') : '';
            const github    = shouldInclude('github')    ? (personal.github    || header.github    || '') : '';
            const portfolio = shouldInclude('portfolio') ? (personal.portfolio || header.portfolio || '') : '';
            const headline  = header.headline || meta.cargo_alvo || 'Desenvolvedor';

            let location = '';
            if (shouldInclude('city') || shouldInclude('state')) {
                const city  = shouldInclude('city')  ? (personal.city  || '') : '';
                const state = shouldInclude('state') ? (personal.state || '') : '';
                location = [city, state].filter(Boolean).join(', ');
            }
            const showRemote = shouldInclude('remote') && personal.remote === true;

            const html = `
                <div class="resume-header">
                    ${name ? `<h1 class="name">${name}</h1>` : ''}
                    <div class="headline">${headline}</div>
                    ${email || phone ? `<div class="contact-info">
                        ${email ? `<span>e-mail: ${email}</span>` : ''}
                        ${email && phone ? ' | ' : ''}
                        ${phone ? `<span>celular e WhatsApp: ${phone}</span>` : ''}
                    </div>` : ''}
                    ${linkedin || github || portfolio ? `<div class="contact-info">
                        ${linkedin  ? `<span>LinkedIn: ${linkedin.replace(/https?:\/\//,'')}</span>`  : ''}
                        ${linkedin && (github || portfolio) ? ' | ' : ''}
                        ${github    ? `<span>GitHub: ${github.replace(/https?:\/\//,'')}</span>`      : ''}
                        ${github && portfolio ? ' | ' : ''}
                        ${portfolio ? `<span>Portf√≥lio: ${portfolio.replace(/https?:\/\//,'')}</span>` : ''}
                    </div>` : ''}
                    ${location || showRemote ? `<div class="contact-info">
                        ${location ? `<span>${location}</span>` : ''}
                        ${location && showRemote ? ' | ' : ''}
                        ${showRemote ? '<span>Dispon√≠vel para trabalho remoto</span>' : ''}
                    </div>` : ''}
                </div>
                ${flat.summary ? `<div class="section"><h2 class="section-title">RESUMO PROFISSIONAL</h2><p class="summary-text">${flat.summary}</p></div>` : ''}
                ${flat.core_competencies ? `<div class="section"><h2 class="section-title">COMPET√äNCIAS T√âCNICAS</h2><div class="skills-grid">
                    ${Object.entries(flat.core_competencies).map(([key, values]) => {
                        if (!values || values.length === 0) return '';
                        const titles = {
                            languages_runtime:'Linguagens & Runtime', frameworks_libraries:'Frameworks & Bibliotecas',
                            databases:'Bancos de Dados', bancos_de_dados:'Bancos de Dados',
                            cloud_infrastructure:'Cloud & Infraestrutura', devops_e_infra:'DevOps & Infraestrutura',
                            messaging_queues:'Mensageria & Filas', testing_quality:'Testes & Qualidade',
                            devops_ci_cd:'DevOps & CI/CD', methodologies:'Metodologias', seguranca:'Seguran√ßa'
                        };
                        return `<div class="skill-group"><strong>${titles[key]||key.replace(/_/g,' ')}:</strong><span> ${Array.isArray(values)?values.join(', '):values}</span></div>`;
                    }).join('')}
                </div></div>` : ''}
                ${flat.experience?.length ? `<div class="section"><h2 class="section-title">EXPERI√äNCIA PROFISSIONAL</h2>
                    ${flat.experience.map(exp => {
                        const role = exp.role||exp.position||'Desenvolvedor';
                        const company = exp.company||exp.empresa||'';
                        const period = exp.periodo||formatPeriod(exp.period);
                        let highlights = exp.highlights||exp.descricao||[];
                        if (typeof highlights === 'string') highlights = [highlights];
                        return `<div class="experience-item">
                            <div class="exp-header">
                                <div><h3 class="exp-role">${role}</h3>${company?`<div class="exp-company">${company}</div>`:''}</div>
                                <div class="exp-period">${period}</div>
                            </div>
                            ${highlights.length ? `<ul class="highlights">${highlights.map(h=>`<li>${h}</li>`).join('')}</ul>` : ''}
                            ${exp.stack?.length ? `<div style="margin-top:8px;font-size:13px;color:#6b7280;"><strong>Stack:</strong> ${exp.stack.join(', ')}</div>` : ''}
                        </div>`;
                    }).join('')}
                </div>` : ''}
                ${flat.projects?.length ? `<div class="section"><h2 class="section-title">PROJETOS EM DESTAQUE</h2>
                    ${flat.projects.map(proj => `<div class="project-item">
                        <h3 class="project-name">${proj.name}</h3>
                        ${proj.description ? `<p>${proj.description}</p>` : ''}
                        ${proj.impact?.length ? `<ul class="project-impact">${proj.impact.map(i=>`<li>${i}</li>`).join('')}</ul>` : ''}
                    </div>`).join('')}
                </div>` : ''}
                ${flat.education?.length ? `<div class="section"><h2 class="section-title">FORMA√á√ÉO ACAD√äMICA</h2>
                    ${flat.education.map(edu => `<div class="education-item">
                        <strong>${edu.degree||edu.curso}</strong><br>
                        ${edu.institution||edu.instituicao}${edu.period?` ‚Ä¢ ${formatPeriod(edu.period)}`:''}
                    </div>`).join('')}
                </div>` : ''}
                ${flat.certifications?.length ? `<div class="section"><h2 class="section-title">CERTIFICA√á√ïES</h2>
                    ${flat.certifications.map(cert => `<div class="cert-item">
                        <strong>${cert.name}</strong> ‚Ä¢ ${cert.issuer}${cert.date?` ‚Ä¢ ${formatDate(cert.date)}`:''}
                    </div>`).join('')}
                </div>` : ''}
                ${flat.languages?.length ? `<div class="section"><h2 class="section-title">IDIOMAS</h2>
                    <div class="languages">
                        ${flat.languages.map(lang => `<span><strong>${lang.language||lang.idioma}:</strong> ${lang.proficiency||lang.nivel}</span>`).join(' ‚Ä¢ ')}
                    </div>
                </div>` : ''}`;
            document.getElementById('resumeContent').innerHTML = html;
        }
    </script>
</body>
</html>
